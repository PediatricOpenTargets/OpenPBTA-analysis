---
title: "Repeated sample analysis"
output: 
  html_notebook:
    toc: true
    toc_float: true
params:
  base_run:
    label: "1/0 to histologies-base.tsv" 
    value: 1
    input: integer
---

## Purpose

There are many specimens in the full dataset that are repeated samples from the same participants.
This workbook is a quick summary of those samples, so that we can better select a unique set of specimens for downstream analysis. 
This is particularly important for analyses such as mutation co-occurence, where repeated sampling will inflate apparent co-ocurrence measures.


```{r setup}
# load libraries
library(dplyr)
```


```{r load files}
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "independent-samples-release")

# source sample selection function
source(file.path(analysis_dir, "util", "independent-dna-samples.R"))
set.seed(201910)

if(params$base_run == 0) {
sample_df <- readr::read_tsv(file.path(root_dir, "data", "histologies.tsv"), guess_max = 10000)
} else {
sample_df <- readr::read_tsv(file.path(root_dir, "data", "histologies-base.tsv"), guess_max = 10000)
}
```

## WGS, WXS, and panel samples
Sort to just sequencing samples of tumors
```{r}
seq_samples <- sample_df %>%
  filter(experimental_strategy %in% c("WGS", "WXS", "Targeted Sequencing"), 
         sample_type == "Tumor")
```

How many WGS, how many WXS, how many panel, summarize #s of samples and participants by 
```{r}
seq_samples %>%
  group_by(experimental_strategy, composition, tumor_descriptor) %>%
  summarise(samples = length(unique(Kids_First_Biospecimen_ID)),
            participants = length(unique(Kids_First_Participant_ID)), 
  ) 
```

~~What if we reduce to the earliest sample for each participant?~~
Note: this analysis was based on an earlier version of the data where `age_at_diagnosis_days` was not uniform across samples and was presumed to indicate sampling date. 
This was incorrect.
All samples from an individual now have the same `age_at_diagnosis_days`.

```{r}
early_samples <- seq_samples %>%
  group_by(Kids_First_Participant_ID) %>%
  summarize(age_at_diagnosis_days = min(age_at_diagnosis_days)) %>%
  left_join(seq_samples) %>%
  pull(Kids_First_Biospecimen_ID) %>%
  unique()

seq_samples %>% 
  filter(Kids_First_Biospecimen_ID %in% early_samples) %>%
  group_by(experimental_strategy, composition, tumor_descriptor) %>%
  summarise(samples = length(unique(Kids_First_Biospecimen_ID)),
            participants = length(unique(Kids_First_Participant_ID)), 
  )
```

## Derived cell lines

Are there any samples for which we only have derived cell lines?

```{r}
derived_participants <- seq_samples %>%
  filter(composition == "Derived Cell Line") %>%
  pull(Kids_First_Participant_ID) %>%
  unique() 

non_derived_participants <- seq_samples %>% 
  filter(composition != "Derived Cell Line") %>%
  pull(Kids_First_Participant_ID) %>%
  unique() 

notissue_participants  <- derived_participants[!(derived_participants %in% non_derived_participants)]
length(notissue_participants)

```

Looks like there is a cell line sample with no corresponding tumor.

```{r}
seq_samples %>%
  filter(Kids_First_Participant_ID %in% notissue_participants)
```

Since this is only one sample it seems like the best move will be to remove all derived cell lines.

## Unknown tumor descriptor samples
Remove samples with unknown or NA tumor descriptor (all DGD)

```{r}

unknown_biospecimens <- seq_samples %>%
  filter(tumor_descriptor %in% c("Not Reported", "Unavailable") | is.na(tumor_descriptor)) %>%
  pull(Kids_First_Biospecimen_ID) %>%
  unique() 

seq_samples <- seq_samples %>% 
  filter(!Kids_First_Biospecimen_ID %in% unknown_biospecimens)

```


## WGS vs WXS vs Panel
```{r}
WXS_participants <- seq_samples %>%
  filter(experimental_strategy == "WXS") %>%
  pull(Kids_First_Participant_ID) %>%
  unique() 

WGS_participants <- seq_samples %>%
  filter(experimental_strategy == "WGS") %>%
  pull(Kids_First_Participant_ID) %>%
  unique() 

Panel_participants <- seq_samples %>%
  filter(experimental_strategy == "Targeted Sequencing") %>%
  pull(Kids_First_Participant_ID) %>%
  unique() 

wxs_panel <- unique(c(WXS_participants, Panel_participants))

No_WGS <- wxs_panel[!(wxs_panel %in% WGS_participants)]

length(No_WGS)
```
## Summarize repeated samples

```{r}
repeat_samples <- seq_samples %>% 
  dplyr::filter(Kids_First_Biospecimen_ID %in% early_samples, 
                experimental_strategy == "WGS") %>%
  dplyr::filter(composition != "Derived Cell Line") %>%
  dplyr::filter(Kids_First_Participant_ID %in% 
                  Kids_First_Participant_ID[duplicated(Kids_First_Participant_ID)])

repeat_samples %>% 
  group_by(Kids_First_Participant_ID) %>%
  summarise(samples = paste(Kids_First_Biospecimen_ID, collapse = ", "), 
         descriptors = paste(sort(unique(tumor_descriptor)),  collapse = ", "),
         age_diagnosis = paste(sort(unique(age_at_diagnosis_days)), collapse = ", "),
         experimental_stragegy = paste(sort(unique(experimental_strategy)), collapse = ", ")
  )
```


## Select independent samples
I created a function `independent_samples()`
to select the earliest biospecimen from each participant, or in the case of more 
than one with the same date, randomly select among the available samples.

An example of this function is below, applied to the WGS Solid Tissue tumor samples.
Note that in this case, only tumors designated as primary will be included, 
though this can be adjusted with `tumor_types = "prefer_primary"` or 
`tumor_types = "any"` if we want to be less presecriptive. As of v5, primary tumors
are defined as those designated "Initial CNS Tumor" or "Diagnosis" in the
`tumor_descriptor` field.

In the accompanying script, I will generate both `primary_only` and `primary_plus` 
sets using the `"primary"` and `"prefer_primary"` resepectively.



```{r}
independents <- sample_df %>%
  filter(experimental_strategy == "WGS", 
         sample_type == "Tumor", 
         composition != "Derived Cell Line") %>%
  independent_samples(tumor_types = "primary")

nrow(independents)
```

Just for reference, lets see what tumor types we end up with in this set:

```{r}
sample_df %>% 
  filter(Kids_First_Biospecimen_ID %in% independents$Kids_First_Biospecimen_ID) %>%
  group_by(broad_histology) %>%
  summarize(n = n())
```



### Session info

```{r}
sessionInfo()
```
