---
title: "Molecularly Subtyping EPN Tumors"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Komal S. Rathi (adapted from python notebook by Teja Koganti)
date: 2022
---

## Usage

This notebook is intended to be run via the command line from the top directory
of the repository as follows:

```
Rscript -e "rmarkdown::render('analyses/molecular-subtyping-EPN/03-summary.Rmd', clean = TRUE)"
```

## Set Up

### Libraries and functions

```{r include = FALSE}
knitr::opts_chunk$set(comment = NA)
getOption(x = 'DT.warn.size', default = FALSE)
```

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(DT)
})
```

```{r dt_function, echo = FALSE}
# custom datatable function
viewDataTable <- function(dat){
  DT::datatable(dat,
                rownames = FALSE,
                filter = "bottom",
                class = 'cell-border stripe',
                options = list(pageLength = 5,
                               searchHighlight = TRUE,
                               scrollX = TRUE,
                               dom = 'tpi',
                               initComplete = JS("function(settings, json) {",
                                            "$(this.api().table().header()).css({'background-color':
                                            '#004467', 'color': '#fff'});","}"))
                )
}
```

### Directories

```{r}
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
data_dir <- file.path(root_dir, "data")
```

### Read in relevant files

```{r message=FALSE}
# Reading in table from results folder without the subgroup column
EPN_final <- read_tsv("results/EPN_all_data.tsv")
EPN_final <- read_tsv("results/EPN_all_data.tsv") %>%
  mutate(subgroup = case_when(is.na(Kids_First_Biospecimen_ID_DNA) & is.na(Kids_First_Biospecimen_ID_RNA) &
                                  !is.na(Kids_First_Biospecimen_ID_Methyl) & is.na(molecular_subtype_methyl) ~ NA_character_,
				                                TRUE ~ as.character("EPN, To be classified")))
```

### Spinal prioritization

We will first prioritize samples from spinal cord to be assigned to "EPN, SP" or "EPN, SP-MYCN" (if MYCN amplification also observed) as described in [reference]. These samples will not be considered for further subgrouping. 

```{r}
EPN_final <- EPN_final %>%
  mutate(subgroup = ifelse(disease_group == "spinal" & grepl("amplification", consensus_focal_CN_MYCN), "EPN, SP-MYCN", subgroup))
sp_mycn_samples_assigned <- EPN_final %>%
  filter(subgroup == "EPN, SP-MYCN") %>%
  pull(sample_id)
print(paste("Number of samples assigned for SP-MYCN:", length(sp_mycn_samples_assigned)))
```

### SP subgroup table

```{r}
viewDataTable(EPN_final %>%
                filter(subgroup == "EPN, SP-MYCN"))
```

### Fusion prioritization

We will next prioritize ZFTA (formaerly C11orf95) and YAP1 fusions based on evidence for these subgroups from Pajtler. et al. Fig.6

### ZFTA gene fusions

1. Here we are prioritizing ZFTA (formerly C11orf95) fusions, if any of the ZFTA fusions are present for a sample, it is assigned "EPN, ST ZFTA"
2. These samples will not be considered for further subgrouping

```{r}
st_epn_zfta_fusions = c("ZFTA--RELA", "ZFTA--MAML2")
df <- EPN_final[,st_epn_zfta_fusions]
df[] <- lapply(df, as.logical)
EPN_final$tmp <- apply(df, MARGIN = 1, any)
EPN_final$tmp[is.na(EPN_final$tmp)] <- FALSE
EPN_final <- EPN_final %>%
  mutate(subgroup = ifelse(subgroup == "EPN, To be classified" & tmp == TRUE, "EPN, ST ZFTA", subgroup)) %>%
  dplyr::select(-c(tmp))
zfta_samples_assigned <- EPN_final %>%
  filter(subgroup == "EPN, ST ZFTA") %>%
  pull(sample_id)
print(paste("Number of samples assigned for ZFTA:", length(zfta_samples_assigned)))
```

### ZFTA subgroup table

```{r}
viewDataTable(EPN_final %>%
                filter(subgroup == "EPN, ST ZFTA"))
```

### YAP1 gene fusions

1. Here we are prioritizing YAP1 fusions, if any of the YAP1 fusions are present for a sample that has not been subgrouped, it is assigned "EPN, ST YAP1"
2. These samples will not be considered for further subgrouping

```{r}
st_epn_yap1_fusions = c("YAP1--MAMLD1", "YAP1--MAML2", "YAP1--FAM118B")
df <- EPN_final[,st_epn_yap1_fusions]
df[] <- lapply(df, as.logical)
EPN_final$tmp <- apply(df, MARGIN = 1, any)
EPN_final$tmp[is.na(EPN_final$tmp)] <- FALSE
EPN_final <- EPN_final %>%
  mutate(subgroup = ifelse(subgroup == "EPN, To be classified" & tmp == TRUE, "EPN, ST YAP1", subgroup)) %>%
  dplyr::select(-c(tmp))
yap1_samples_assigned <- EPN_final %>%
  filter(subgroup == "EPN, ST YAP1") %>%
  pull(sample_id)
print(paste("Number of samples assigned for YAP1:", length(yap1_samples_assigned)))
```
### YAP1 subgroup table

```{r}
viewDataTable(EPN_final %>%
                filter(subgroup == "EPN, ST YAP1"))
```

### PT_EPN subgroups

1. Here we will assign the PT_EPN_A and PT_EPN_B subgroups to the sample that have not been subgrouped before. 
2. Based on Pajtler et al. fig. 4, over expression of EZHIP (formerly CXorf67) and TKTL1 along with 1q gain is seen under PT_EPN_A subgroup

3. Similarly GPBP1 and IFT46 shows over expression along with 6p and 6q loss in PT_EPN_B subgroup


```{r}
EPN_final <- EPN_final %>%
  mutate(subgroup = case_when(
    subgroup == "EPN, To be classified" & `1q_gain` > 0 & TKTL1_expr_zscore > 3 ~  "EPN, PF A",
    subgroup == "EPN, To be classified" & EZHIP_expr_zscore > 3 ~ "EPN, PF A",
    subgroup == "EPN, To be classified"  & CNS_region == "Posterior fossa" & 
      (EPN_final$`H3-3A_HGVSp_Short` == "p.K28M" | EPN_final$`H3-3B_HGVSp_Short` == "p.K28M" | H3C2_HGVSp_Short == "p.K28M" | 
         H3C3_HGVSp_Short == "p.K28M" | H3C14_HGVSp_Short == "p.K28M") ~ "EPN, PF A",
    subgroup == "EPN, To be classified" & (`6q_loss` > 0 | `6p_loss` > 0) & 
      (GPBP1_expr_zscore > 3 | IFT46_expr_zscore > 3) ~ "EPN, PF B",
    subgroup == "EPN, To be classified" & !is.na(molecular_subtype_methyl) ~ molecular_subtype_methyl,
    TRUE ~ subgroup)
    )
                     
epn_pfa_samples_assigned <- EPN_final %>%
  filter(subgroup == "EPN, PF A") %>%
  pull(sample_id)
print(paste("Number of samples assigned for PT_EPN_A:", length(epn_pfa_samples_assigned)))

epn_pfb_samples_assigned <- EPN_final %>%
  filter(subgroup == "EPN, PF B") %>%
  pull(sample_id)
print(paste("Number of samples assigned for PT_EPN_B:", length(epn_pfb_samples_assigned)))
```

### PT_EPN table

```{r}
viewDataTable(EPN_final %>%
                filter(subgroup %in% c("EPN, PF A", "EPN, PF B")))
```

### Adding `SV_instability` and `CNV_instability` columns to the final dataframe

```{r}
# print dataframe without the columns
viewDataTable(EPN_final %>% head())

# add columns
sv_iqr <- IQR(EPN_final$`breaks_density-chromosomal_instability_SV`, na.rm = T)
sv_median <- median(EPN_final$`breaks_density-chromosomal_instability_SV`, na.rm = T)
cnv_iqr = IQR(EPN_final$`breaks_density-chromosomal_instability_CNV`, na.rm = T)
cnv_median = median(EPN_final$`breaks_density-chromosomal_instability_CNV`, na.rm = T)
EPN_final$SV_instability <- sapply(EPN_final$`breaks_density-chromosomal_instability_SV`, 
                                     FUN = function(x) x-sv_median/sv_iqr)
EPN_final$CNV_instability <- sapply(EPN_final$`breaks_density-chromosomal_instability_CNV`, 
                                     FUN = function(x) x-cnv_median/cnv_iqr)

# sort final table
EPN_final <- EPN_final %>% 
  mutate(subgroup = ifelse(is.na(subgroup), "N/A", subgroup)) %>%
  arrange(Kids_First_Participant_ID, sample_id)

# write out final file 
write_tsv(EPN_final, "results/EPN_all_data_withsubgroup.tsv")

# print full dataframe after adding the columns
viewDataTable(EPN_final)
```

### Summary of final subtype counts

```{r}
viewDataTable(EPN_final %>%
                group_by(subgroup) %>%
                summarise(n = n()))

```

