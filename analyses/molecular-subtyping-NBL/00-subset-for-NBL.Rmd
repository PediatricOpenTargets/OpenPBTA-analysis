---
title: "Subset the data for MYCN-NBL"
author: "Aditya Lahiri, Eric Wafula, Jo Lynne Rokita"
date: "10/13/2022"
output: html_notebook
---
Objective: This notebook loads the histology file and selects the NBL biospecimen by filtering for tumor only


#Load Libraries

```{r load libraries}
suppressPackageStartupMessages({
library(dplyr)
library(data.table)
library(tidyverse)
})
```


#Set up directories
```{r setup directories}
# root directory
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

# data directory
data_dir <- file.path(root_dir, "data")

# module directory
moduleDir <- file.path(root_dir, "analyses","molecular-subtyping-NBL")

#results directory
results_dir <- "results"
# create if doesn't exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
```


#Load the files for histology, consensus, and tpm data
```{r load the data files: this will take time}
hist_df<-readr::read_tsv(file.path(data_dir, "histologies-base.tsv"),guess_max = 100000)

consensus_df<-readr::read_tsv(file.path(data_dir, "consensus_wgs_plus_cnvkit_wxs.tsv.gz"),
                              guess_max = 100000)

gene_expression_df<-as.data.frame(readRDS(paste(data_dir,"/",
                                                "gene-expression-rsem-tpm-collapsed.rds",sep="")))
```

Background: 
NBL is defined as neuroblastoma, ganglioneuroblastoma, and ganglioneuroma.These diseases are 
mentioned in the histology-base.tsv file. 

consensus_wgs_plus_cnvkit_wxs.tsv.gz has information regarding copy number, status, and 
gene symbol (MYCN). 

gene-expression-rsem-tpm-collapsed.rds file has MYCN TPM values.


Code Logic: 
We first filter the histology-base.tsv file for NBL samples based on pathology_diagnosis, 
sample_type,and experimental strategy. The pathology_diagnosis can have certain values as listed in
the code chunk below. The sample type we query for is "tumor", i.e. we exclude "normal" samples. 
For experimental strategy, we consider WGS, WXS, Targeted Sequencing, and RNA-Seq. We ultimately 
want to create an output table with DNA and RNA biospecimen IDs, with their corresponding molecular 
subtype, so we will need get DNA and RNA samples from the histology file. 

We filter the consensus_wgs_plus_cnvkit_wxs.tsv.gz and gene-expression-rsem-tpm-collapsed.rds for
MYCN to get the relevant information. 

# Data Filtering
```{r Data filtering}
# First filter the histology file based on diseases we are intereseted in neuroblastoma, 
# ganglioneuroblastoma, and ganglioneuroma

hist_filtered_df <- hist_df %>% 
  filter(sample_type=="Tumor", 
         experimental_strategy %in% c("WGS", "WXS", "Targeted Sequencing", "RNA-Seq")) %>%
  filter(pathology_diagnosis== "Neuroblastoma" |
           pathology_diagnosis== "Ganglioneuroblastoma" |
           pathology_diagnosis== "Ganglioneuroblastoma, nodular" |
           pathology_diagnosis == "Ganglioneuroblastoma, intermixed" |
           pathology_diagnosis == 
           "Ganglioneuroma, maturing subtype OR Ganglioneuroblastoma, well differentiated")


# The consensus_wgs_plus_cnvkit_wxs.tsv.gz file has all types of genes, we just need MYCN, 
#  so we filter the dataset as follows:
consensus_filtered_df <- consensus_df %>% filter(gene_symbol=="MYCN")

# Get MYCN TPM Data
MYCN_Index <- which(rownames(gene_expression_df)=="MYCN") # find which rows (contains gene names) 

#corresponds to MYCN

TPM_MYCN_data <- gene_expression_df[MYCN_Index,] # Get the TPM data for for MYCN
```

Code Logic:
We will integrate the TMP and consensus data with the hist_filtered using left join. Histology file 
has all the biospecimens but we are only concerned with NBL-biospecimens, so we use the filtered 
version of histology file (`hist_filtered_df`). 

# Get TPM , Copy Number and Status
```{r Getting TPM, Copy Number and Status info}
#Add the satus and copy Number to these samples. Adding the information if available, so we do a 
#left join with respect to hist_filtered_df as we don't want to discard any biospecimen of MYCN-NBL
#for which Status and copy number is not avaialable
MYCN_DF<-left_join(hist_filtered_df,consensus_filtered_df,by= c("Kids_First_Biospecimen_ID" 
                                                                = "biospecimen_id"))

#Add TPM in  a similar fashion as copy number and status 
rownames(TPM_MYCN_data)<-"MYCN_TPM" # Defining the column names of tpm values
TPM_MYCN_data<-t(TPM_MYCN_data) # coverting 1 X N matrix to N X 1 matrix (lenght wise)
TPM_MYCN_data <-as.data.frame(TPM_MYCN_data) # Convert to data framte 
# Make ID rownames into a column 
TPM_MYCN_data <- tibble::rownames_to_column(TPM_MYCN_data, "Kids_First_Biospecimen_ID") 
# Finally add the TPM data using left join
MYCN_DF<- left_join(MYCN_DF,TPM_MYCN_data, by="Kids_First_Biospecimen_ID") 
```

# Write the mycn-nbl biospecimen file into results dir
```{r write alteration table}
MYCN_DF%>%readr::write_tsv(file.path(results_dir, "mycn_nbl_subset_data.tsv"))
```


