---
title: "02-find-non-matching-biospecimen"
output: html_document
author: "Aditya Lahiri, Eric Wafula, Jo Lynne Rokita"
date: "10/13/2022"
---
```{r load libraries}
suppressPackageStartupMessages({
library(dplyr)
library(data.table)
library(tidyverse)
library(ggplot2)
})
```

#Set up directories
```{r setup directories}
# root directory
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

# data directory
dataDir <- file.path(root_dir, "data")

# module directory
moduleDir <- file.path(root_dir, "analyses","molecular-subtyping-NBL")

#results directory
results_dir <- "results"
# create if doesn't exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

#plot directory
plot_dir <- "plots"
# create if doesn't exist
if (!dir.exists(plot_dir)) {
  dir.create(plot_dir)
}
```


# Read the mycn-nbl file and the clinical patient-status mapping files for GMKF and TARGET
```{r read the file containing mycn-nbl biospecimen}
MYCN_DF<-readr::read_tsv(file.path(results_dir, "mycn_nbl_subset_data.tsv"),guess_max = 100000)
MYCN_DNA_RNA_FILTERED_DF<-readr::read_tsv(file.path(results_dir,"mycn_nbl_matched_biospecimen.tsv"),guess_max = 100000)

gmkf_patient_clinical_mycn_status_df <- readr::read_tsv(file.path(moduleDir, "input/gmkf_patient_clinical_mycn_status.tsv"),guess_max = 100000)

target_patient_clinical_mycn_status_df<- readr::read_tsv(file.path(moduleDir, "input/target_patient_clinical_mycn_status.tsv"),guess_max = 100000)
```


Code Logic: 
Now that we have found the data for which containing matched DNA and RNA IDs. We need to identify 
the data that only have DNA IDs or RNA IDs. To do this we first create and exhaustive list of all
NBL-MYCN IDs from the dataframe MYCN_DF. MYCN_DF contains all the IDs which are NBL from the 
histology file, and there are some repeating IDs in MYCN_DF. 

Once we have a list of all unique IDs in MYCN_DF, we remove from them the Matched DNA and RNA IDs 
in MYCN_DNA_RNA_FILTERED_DF. This will leave us with only the IDs that only have a DNA ID or RNA ID
but never both. 

Add IDs that don't necessarily have both DNA and RNA 
# Create dataframe of samples where DNA and RNA IDs dont match 
```{r Find DNA only and RNA only samples}
MYCN_IDs_exhaustive <- as.data.frame(unique(MYCN_DF$Kids_First_Biospecimen_ID)) 
# Has every biospecimen ID of NBL-MYCN samples 1505 samples in total.  MYCN_DF has 1508 samples 
#as we have  the follwing repeating IDs with different copy numbers TARGET-30-PAMDAL-01A-01W, 
# TARGET-30-PAPVFD-01A-01D, TARGET-30-PASXRG-01A-01D  

colnames(MYCN_IDs_exhaustive)<-"Kids_First_Biospecimen_ID"


# Last two are sorted out in DNA-RNA matching 

# 676 samples but half of them are DNA and rest are corresponding RNA  
MYCN_IDs_with_DNA_RNA <- as.data.frame(c(MYCN_DNA_RNA_FILTERED_DF$Kids_First_Biospecimen_ID_DNA,
                               MYCN_DNA_RNA_FILTERED_DF$Kids_First_Biospecimen_ID_RNA)) 

colnames(MYCN_IDs_with_DNA_RNA)<-"Kids_First_Biospecimen_ID"

MYCN_IDs_without_DNA_RNA_Match <- as.data.frame(MYCN_IDs_exhaustive[-(which(
  MYCN_IDs_exhaustive$Kids_First_Biospecimen_ID %in% 
    MYCN_IDs_with_DNA_RNA$Kids_First_Biospecimen_ID)),])

# 830 samples here (# 1505-676= 829 => 829+1 =830)
colnames(MYCN_IDs_without_DNA_RNA_Match)<- "Kids_First_Biospecimen_ID"
```


Code Logic: We now need to identify with of the IDs in MYCN_IDs_without_DNA_RNA_Match are DNA IDs 
and which RNA IDs. If a sample in MYCN_IDs_without_DNA_RNA_Match is a DNA ID then it will be in  
MYCN_dna_df which contains all the NBL DNA IDs, otherwise it will be an RNA ID which will be 
contained in MYCN_rna_df (contains all RNA NBL IDs). Then we create dataframes for DNA only and RNA 
only samples with relevant column information. These dataframes will specifically have a column for 
DNA ID and another for RNA ID. We then concatenate these two dataframes to create the a dataframe of 
unmatched DNA and RNA IDs samples, this dataframe is : MYCN_non_match_df.

Now we need to identify which IDs in MYCN_IDs_without_DNA_RNA_Match are DNA IDs and Which are RNA IDs
```{r}
# 762 samples 
DNA_IDs_MYCN_Non_Match <- 
  as.data.frame(MYCN_IDs_without_DNA_RNA_Match
                [which(MYCN_IDs_without_DNA_RNA_Match$Kids_First_Biospecimen_ID 
                       %in% MYCN_dna_df$Kids_First_Biospecimen_ID_DNA),]) 
colnames(DNA_IDs_MYCN_Non_Match)<- "Kids_First_Biospecimen_ID_DNA"

# 68 samples,762+68= 830 samples as expected.
RNA_IDs_MYCN_Non_Match <- 
  as.data.frame(MYCN_IDs_without_DNA_RNA_Match
                [which(MYCN_IDs_without_DNA_RNA_Match$Kids_First_Biospecimen_ID 
                       %in% MYCN_rna_df$Kids_First_Biospecimen_ID_RNA),])  
colnames(RNA_IDs_MYCN_Non_Match)<- "Kids_First_Biospecimen_ID_RNA"

# Make dfs DNA and RNA IDs found here with  

DNA_only_MYCN_df<- MYCN_DF %>% filter(Kids_First_Biospecimen_ID %in% 
                                        DNA_IDs_MYCN_Non_Match$Kids_First_Biospecimen_ID_DNA)

DNA_only_MYCN_df <- DNA_only_MYCN_df %>% select(Kids_First_Biospecimen_ID,
                                                Kids_First_Participant_ID,MYCN_TPM,copy_number,
                                                status,pathology_free_text_diagnosis)  # 763 samples 
colnames(DNA_only_MYCN_df)[1]<- "Kids_First_Biospecimen_ID_DNA"

# An extra sample is created due to copy number and status variation TARGET-30-PAMDAL-01A-01W	
# Retain the sample with high copy number 
index_dna_only <- which(DNA_only_MYCN_df$Kids_First_Biospecimen_ID_DNA=="TARGET-30-PAMDAL-01A-01W" 
                        & DNA_only_MYCN_df$copy_number==3 &
                        DNA_only_MYCN_df$status=="neutral")

DNA_only_MYCN_df<- DNA_only_MYCN_df[-c(index_dna_only),]

RNA_only_MYCN_df<- MYCN_DF %>% filter(Kids_First_Biospecimen_ID %in% 
                                        RNA_IDs_MYCN_Non_Match$Kids_First_Biospecimen_ID_RNA)

RNA_only_MYCN_df <- RNA_only_MYCN_df %>% select(Kids_First_Biospecimen_ID,Kids_First_Participant_ID,
                                                MYCN_TPM,copy_number,status,
                                                pathology_free_text_diagnosis) # 68 samples
colnames(RNA_only_MYCN_df)[1]<- "Kids_First_Biospecimen_ID_RNA"


# Add biospecimen_dna_id and biospecimen_rna_id accordingly

DNA_only_MYCN_df$Kids_First_Biospecimen_ID_RNA<- NA_character_
RNA_only_MYCN_df$Kids_First_Biospecimen_ID_DNA<- NA_character_

# Rearrange the columns to make it look like MYCN_DNA_RNA_FILTERED_DF
DNA_only_MYCN_df<- DNA_only_MYCN_df[,c(1,7,2:6)] 
RNA_only_MYCN_df<- RNA_only_MYCN_df[,c(7,1:6)] 

# Combine the above two dfs, these are DFs where either DNA or RNA Biospecimen_ID is missing
MYCN_non_match_df <- rbind(DNA_only_MYCN_df,RNA_only_MYCN_df)
```


Code Logic: Create subtyping table by concatenating MYCN_non_match_df we created above and
the dataframe containing matched DNA and RNA IDs in MYCN_DNA_RNA_FILTERED_DF. 
# Create subtyping Table
```{r : select only relevant data for subtyping table}
# select only relevant columns from MYCN_DNA_RNA_FILTERED_DF and store it in alteration_df
alteration_df <- MYCN_DNA_RNA_FILTERED_DF %>% select(Kids_First_Biospecimen_ID_DNA,
                                                     Kids_First_Biospecimen_ID_RNA,
                                                     Kids_First_Participant_ID,
                                                     MYCN_TPM,copy_number,MYCN_TPM,status,
                                                     pathology_free_text_diagnosis) 

# concatenate matched DNA and RNA IDs with DNA only and RNA only dfs. 
alteration_df <- rbind(alteration_df,MYCN_non_match_df)
```


Code Logic: pathology_free_text_diagnosis column has multiple of NA values in the alteration_df. 
To resolve this issue we use the files in the input folder which are NBL MCYN clinical 
patient-status mapping files for GMKF and TARGET samples. These NA values will be integrated in the 
V12 version. 

```{r integrate new pathology free text diagnosis values from input folder}
# Bring in the extra pathology free diagnonsis text from files in input folder:
colnames(gmkf_patient_clinical_mycn_status_df)<-c("Kids_First_Participant_ID",
                                                  "pathology_free_text_diagnosis_gmfk")
colnames(target_patient_clinical_mycn_status_df)<-c("Kids_First_Participant_ID",
                                                    "pathology_free_text_diagnosis_target")

alteration_df<- left_join(alteration_df,gmkf_patient_clinical_mycn_status_df,
                          by="Kids_First_Participant_ID")

alteration_df<- left_join(alteration_df,target_patient_clinical_mycn_status_df,
                          by="Kids_First_Participant_ID")

alteration_df<-alteration_df%>% mutate(pathology=coalesce(pathology_free_text_diagnosis,
                                                          pathology_free_text_diagnosis_gmfk,
                                                          pathology_free_text_diagnosis_target))

alteration_df<-alteration_df %>% select(Kids_First_Biospecimen_ID_DNA,Kids_First_Biospecimen_ID_RNA,                            
                                        MYCN_TPM,copy_number,MYCN_TPM,status,pathology)

colnames(alteration_df)[6]<- "pathology_free_text_diagnosis"

```


Code Logic: Plot the TPM values for biospecimens which have TPMs both for  Matched and Non Matched  
biospecimens.

```{r Plot of all biospecimen with TPMs}
plot_alteration_df <- alteration_df %>% filter(!is.na(MYCN_TPM))
plot_alteration_df<- plot_alteration_df %>% mutate(Kids_First_Biospecimen_ID=
                                                     coalesce(Kids_First_Biospecimen_ID_DNA,
                                                              Kids_First_Biospecimen_ID_RNA))

bar_plot2<-plot_alteration_df %>% 
  arrange(MYCN_TPM) %>% 
  mutate(Kids_First_Biospecimen_ID = factor(Kids_First_Biospecimen_ID, 
                                            unique(Kids_First_Biospecimen_ID))) %>%
  ggplot() +aes(x=Kids_First_Biospecimen_ID, y=MYCN_TPM, fill=status)+
  geom_bar(position="dodge",stat="identity")+
  theme(axis.text.x = element_text(size = 2, angle = 45, hjust = 1))
bar_plot2

Suggested_Cutoff<-140.83 # TARGET-30-PAMEZH-01A-01R	
bar_plot2+ geom_hline(aes(yintercept=Suggested_Cutoff,linetype = "Suggested Amp Cutoff"),
                      color = "black",size=2) #TARGET-30-PAPKXS-01A-01D	

plot_file <- file.path(plot_dir, "TPM_Biospecimen_All_Samples_With_TMP.png")
ggsave(filename = plot_file,width = 49, height = 20)
```


Write NBL-MYCN biospecimen to subtyped into the results folder
```{r}
alteration_df%>%readr::write_tsv(file.path(results_dir, "alteration_table_without_subtype.tsv"))
```