---
title: "04-QC Checks"
author: "Aditya Lahiri, Eric Wafula, Jo Lynne Rokita"
date: "11/14/2022"
output: html_notebook
---

This notebook performs QC check for TARGET and GMKF samples and stores results in the table
`results/qc_table.tsv

#Load Libraries

```{r load libraries}
library(dplyr)
library(data.table)
library(tidyverse)
```

#Set up directories
```{r setup directories}
# root directory
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

# data directory
data_dir <- file.path(root_dir, "data")

# module directory
module_dir <- file.path(root_dir, "analyses","molecular-subtyping-NBL")

#results directory
results_dir <- "results"
# create if doesn't exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

```

Code Logic and background: load the TARGET and GMKF data , also slect relevant columns. 
```{r get TARGET GMKF Data}
hist_df<-readr::read_tsv(file.path(data_dir, "histologies-base.tsv"),guess_max = 100000)
alteration_subtyped_df<-readr::read_tsv(file.path(results_dir, "alteration_table_with_molecular_subtype.tsv"),
                               guess_max = 100000)

TARGET<- hist_df %>% filter(cohort=="TARGET",pathology_diagnosis %in% 
                               c("Neuroblastoma", "Ganglioneuroblastoma",
                                 "Ganglioneuroblastoma, nodular",
                                 "Ganglioneuroblastoma, intermixed",
                                 "Ganglioneuroma, maturing subtype OR Ganglioneuroblastoma, well differentiated"),
                            experimental_strategy=="WXS") 

GMKF<- hist_df %>% filter(cohort=="GMKF",pathology_diagnosis %in%
                             c("Neuroblastoma", "Ganglioneuroblastoma",
                               "Ganglioneuroblastoma, nodular",
                               "Ganglioneuroblastoma, intermixed",
                               "Ganglioneuroma, maturing subtype OR Ganglioneuroblastoma, well differentiated"),
                           experimental_strategy=="WGS") 

TARGET <- TARGET %>% select(Kids_First_Biospecimen_ID,Kids_First_Participant_ID,sample_id,
                              cohort,experimental_strategy)
GMKF <- GMKF %>% select(Kids_First_Biospecimen_ID,Kids_First_Participant_ID,sample_id,
                          cohort,experimental_strategy)
```
Create a QC data frame
```{r QC dataframe being created}
QC_df <- inner_join(GMKF,TARGET, by= c("Kids_First_Participant_ID","sample_id"))

QC_df <-  QC_df %>% select(Kids_First_Biospecimen_ID.x,Kids_First_Biospecimen_ID.y,
                           Kids_First_Participant_ID,sample_id,cohort.x,cohort.y,
                           experimental_strategy.x,experimental_strategy.y)

colnames(QC_df)<- c("Kids_First_Biospecimen_ID_GMKF","Kids_First_Biospecimen_ID_TARGET",
                        "Kids_First_Participant_ID","sample_id","cohort_GMKF","cohort_TARGET",
                        "experimental_strategy_GMKF","experimental_strategy_Target")
# 
# QC_df <- QC_df %>% mutate(MYCN_TPM_GMKF=NA,MYCN_TPM_Target=NA,MYCN_status_GMKF=NA,
#                           MYCN_status_Target=NA,molecular_subtype_GMKF=NA,molecular_subtype_Target=NA)
```

Add status, tpm and subtype infromation from the table results/alteration_table_with_molecular_subtype.tsv
```{r import values molecular subtype table into QC dataframe}
#Iterate through each element of QC_df and find its corresponding TPM, Status, and Subtype from
# results/alteration_table_with_molecular_subtype.tsv

values_from_subtype_table <- matrix(ncol=6)

for (iter in 1:dim(QC_df)[1]){
  index_gmkf <- which(alteration_subtyped_df$Kids_First_Biospecimen_ID_DNA == 
                        QC_df$Kids_First_Biospecimen_ID_GMKF[iter])
  index_target <- which(alteration_subtyped_df$Kids_First_Biospecimen_ID_DNA == 
                          QC_df$Kids_First_Biospecimen_ID_TARGET[iter])

  if(length(index_gmkf) ==0 ){
    index_gmkf <- which(alteration_subtyped_df$Kids_First_Biospecimen_ID_RNA ==
                          QC_df$Kids_First_Biospecimen_ID_GMKF[iter])
  }

  if(length(index_target) ==0 ){
    index_target <- which(alteration_subtyped_df$Kids_First_Biospecimen_ID_RNA == 
                            QC_df$Kids_First_Biospecimen_ID_TARGET[iter])
  }
  
  values_gmkf_target <- c(alteration_subtyped_df$MYCN_TPM[index_gmkf],
                          alteration_subtyped_df$MYCN_TPM[index_target],
                          alteration_subtyped_df$MYCN_CN_status[index_gmkf],
                          alteration_subtyped_df$MYCN_CN_status[index_target],
                          alteration_subtyped_df$molecular_subtype[index_gmkf],
                          alteration_subtyped_df$molecular_subtype[index_target])
  
  
 values_from_subtype_table<- rbind(values_from_subtype_table,values_gmkf_target)
}
values_from_subtype_table <- values_from_subtype_table[-1,]
values_from_subtype_table <-as.data.frame(values_from_subtype_table)
rownames(values_from_subtype_table)<-NULL
colnames(values_from_subtype_table)<-c("MYCN_TPM_GMKF","MYCN_TPM_Target","MYCN_status_GMKF",
                                       "MYCN_status_TARGET","molecular_subtype_GMKF",
                                       "molecular_subtype_TARGET")
```


```{r assign QC values}

QC_df <- cbind(QC_df,values_from_subtype_table)
# QC_df <- QC_df %>% mutate(MYCN_TPM_GMKF=values_from_subtype_table[,1],
#                           MYCN_TPM_Target=values_from_subtype_table[,3],
#                           MYCN_status_GMKF=values_from_subtype_table[,2],
#                           MYCN_status_Target=values_from_subtype_table[,5],
#                           molecular_subtype_GMKF=values_from_subtype_table[,3],
#                           molecular_subtype_Target=values_from_subtype_table[,6])
```


 Write the table
```{r write alteration table}
QC_df%>%readr::write_tsv(file.path(results_dir, "qc_table.tsv"))
```



