---
title: "02-tpm-tables-checks-bash"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
author: Aditya Lahiri
date: 2022-11-07
params:
  current_table_gene:
    label: "current tpm gene wise table"
    value: current/long_n_tpm_mean_sd_quantile_gene_wise_zscore.tsv.gz
    input: file
  previous_table_gene:
    label: "previous tpm gene wisetable"
    value: previous/long_n_tpm_mean_sd_quantile_gene_wise_zscore.tsv.gz
    input: file
  current_table_group:
    label: "current tpm group table"
    value: current/long_n_tpm_mean_sd_quantile_group_wise_zscore.tsv.gz
    input: file  
  previous_table_group:
    label: "previous  tpm group table"
    value: previous/long_n_tpm_mean_sd_quantile_group_wise_zscore.tsv.gz
    input: file    
---



### Purpose
Performs summary and QC checks comparing the current and the previous OpenPedCan 
tpm tables.

### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('02-tpm-tables-checks-bash.Rmd', clean = TRUE)"
```
_This assumes you are in the analysis module directory of the repository,_
_OpenPedCan-analysis/analyses/mutation-frequencies-tables-checks._



### Load packages
```{r load packages}
# R packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(openxlsx))

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```


### Set output directory
```{r set output directory}
# directories for input and output files
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analyses_dir <- file.path(root_dir, "analyses", "mtp-tables-qc-checks")
results_dir <- file.path(analyses_dir, "results")

# Create results folder if it doesn't exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
```

### Functions
```{r functions}
# get number of samples in cohorts
get_num_samples <- function(freq_df) {
  primary_samples <- freq_df %>% 
    dplyr::filter(cohort != "All Cohorts") %>%
    dplyr::select(cohort, Disease,
                  n_samples) %>%
    dplyr::distinct() %>% 
    dplyr::select(-Disease) %>%
    dplyr::group_by(cohort) %>% 
    dplyr::summarise(n_samples = 
                       sum(as.integer(n_samples, na.rm = TRUE)))
    return(primary_samples)
}

# changes in common columns among MPT mutation frequencies  between 
# current and previous tables
changes_in_columns <- function(current_table, previous_table, column_name) {
  # values specific to current table
  specific_to_current <- current_table %>% 
  dplyr::select(cohort, column_name) %>% 
  dplyr::distinct() %>% 
    setdiff(previous_table %>% dplyr::select(cohort, column_name) %>%
              dplyr::distinct()) %>% 
    dplyr::rename(current_dataset = cohort)
  # values specific to previous table
  specific_to_previous <- previous_table %>% 
    dplyr::select(cohort, column_name) %>% 
    dplyr::distinct() %>% 
    setdiff(current_table %>% dplyr::select(cohort, column_name) %>%
              dplyr::distinct()) %>% 
    dplyr::rename(previous_dataset = cohort)
  # combine differences 
  changes_in_columns <- specific_to_current %>%
    dplyr::full_join(specific_to_previous, by = column_name) %>% 
    dplyr::select(column_name, current_dataset, previous_dataset)
  return(changes_in_columns)
}
```


### Read in current and previous tpm files
```{r load files}
current_gene_wise_table <- data.table::fread(params$current_table_gene, 
                                    data.table = FALSE, 
                                   showProgress = FALSE) %>% purrr::discard(~all(is.na(.))) 

previous_gene_wise_table<-data.table::fread(params$previous_table_gene, 
                                    data.table = FALSE, 
                                   showProgress = FALSE) %>% purrr::discard(~all(is.na(.))) 

  

current_group_wise_table<-data.table::fread(params$current_table_group, 
                                    data.table = FALSE, 
                                   showProgress = FALSE) %>% purrr::discard(~all(is.na(.))) 
  
previous_group_wise_table<-data.table::fread(params$previous_table_group, 
                                    data.table = FALSE, 
                                   showProgress = FALSE) %>% purrr::discard(~all(is.na(.)))    
  
  

```


### First 50 records from a static cancer group (GMKF Neuroblastoma) 
Records from a static cancer_group should not change between the current and previous mutation frequencies tables. There should be no changes in computed mutation frequencies. But other fields in the table will likely change if annotations are updated. 
#### Current table
```{r current table gene wise}
# ordered top 50 GMKF Neuroblastoma records from current gene wise table
gmkf_nbl_current_gene_wise <- current_gene_wise_table %>% 
  dplyr::filter(cohort == "GMKF", Disease == "Neuroblastoma") %>% 
  dplyr::arrange() %>% 
  head(n = 50)

# write to file
gmkf_nbl_current_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, "current_group_static_cancer_tpm_gene_wise.tsv")) 

# display      
gmkf_nbl_current_gene_wise   
```

```{r current table group wise}
# ordered top 50 GMKF Neuroblastoma records from current group wise table
gmkf_nbl_current_group_wise <- current_group_wise_table %>% 
  dplyr::filter(cohort == "GMKF", Disease == "Neuroblastoma") %>% 
  dplyr::arrange() %>% 
  head(n = 50)

# write to file
gmkf_nbl_current_group_wise %>% 
  readr::write_tsv(file.path(results_dir, "current_group_static_cancer_tpm_group_wise.tsv")) 

# display      
gmkf_nbl_current_group_wise   
```

#### Previous table

```{r previous table gene wise}
# ordered top 50 GMKF Neuroblastoma records from previous gene wise table
gmkf_nbl_previous_gene_wise <- previous_gene_wise_table %>% 
  dplyr::filter(cohort == "GMKF", Disease == "Neuroblastoma") %>% 
  dplyr::arrange() %>% 
  head(n = 50)

# write to file
gmkf_nbl_previous_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, "previous_group_static_cancer_tpm_gene_wise.tsv"))

# display   
gmkf_nbl_previous_gene_wise  
```


```{r previous table group wise}
# ordered top 50 GMKF Neuroblastoma records from previous table
gmkf_nbl_previous_group_wise <- previous_group_wise_table %>% 
  dplyr::filter(cohort == "GMKF", Disease == "Neuroblastoma") %>% 
  dplyr::arrange() %>% 
  head(n = 50)

# write to file
gmkf_nbl_previous_group_wise %>% 
  readr::write_tsv(file.path(results_dir, "previous_group_static_cancer_tpm_group_wise.tsv"))

# display   
gmkf_nbl_previous_group_wise  
```


### Number of samples in each cohort gene wise
```{r number of samples gene wise}
# get number of samples in each cohort
num_samples_gene_wise <- get_num_samples(current_gene_wise_table) %>% 
  dplyr::rename(samples_in_current_gene_wise = n_samples) %>% 
  dplyr::full_join(get_num_samples(previous_gene_wise_table) %>% 
                    dplyr::rename(samples_in_previous_gene_wise = n_samples), by = "cohort") %>% 
  dplyr::select(cohort, samples_in_current_gene_wise, samples_in_previous_gene_wise)

# write to file
num_samples_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, "number_of_samples_tpm_gene_wise.tsv"), na = "NA")

# display   
num_samples_gene_wise
```

### Number of samples in each cohort group wise
```{r number of samples group wise}
# get number of samples in each cohort
num_samples_group_wise <- get_num_samples(current_group_wise_table) %>% 
  dplyr::rename(samples_in_current_group_wise = n_samples) %>% 
  dplyr::full_join(get_num_samples(previous_group_wise_table) %>% 
                    dplyr::rename(samples_in_previous_group_wise = n_samples), by = "cohort") %>% 
  dplyr::select(cohort, samples_in_current_group_wise, samples_in_previous_group_wise)

# write to file
num_samples_group_wise %>% 
  readr::write_tsv(file.path(results_dir, "number_of_samples_tpm_group_wise.tsv"), na = "NA")

# display   
num_samples_group_wise
```


### Cancer groups in the "All Cohorts" category
```{r all cohorts cancer groups gene wise}
# get All Cohorts" cancer groups
all_cohorts_cancer_groups_tpm_gene_wise <- current_gene_wise_table %>% 
  dplyr::select(cohort, Disease) %>% 
  dplyr::filter(cohort == "All Cohorts") %>% 
  dplyr::distinct() %>%
  dplyr::rename(current_cohort = cohort) %>% 
  dplyr::full_join(previous_gene_wise_table %>% 
                     dplyr::select(cohort, Disease) %>% 
                     dplyr::filter(cohort == "All Cohorts") %>% 
                     dplyr::distinct() %>% 
                     dplyr::rename(previous_cohort = cohort),
                   by = "Disease") %>% 
  dplyr::select(Disease, current_cohort, previous_cohort)

# write to file
all_cohorts_cancer_groups_tpm_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "all_cohorts_cancer_groups_tpm_gene_wise.tsv"), na = "NA")

# display   
all_cohorts_cancer_groups_tpm_gene_wise
  
```



```{r all cohorts cancer groups group wise}
# get All Cohorts" cancer groups
all_cohorts_cancer_groups_tpm_group_wise <- current_group_wise_table %>% 
  dplyr::select(cohort, Disease) %>% 
  dplyr::filter(cohort == "All Cohorts") %>% 
  dplyr::distinct() %>%
  dplyr::rename(current_cohort = cohort) %>% 
  dplyr::full_join(previous_group_wise_table %>% 
                     dplyr::select(cohort, Disease) %>% 
                     dplyr::filter(cohort == "All Cohorts") %>% 
                     dplyr::distinct() %>% 
                     dplyr::rename(previous_cohort = cohort),
                   by = "Disease") %>% 
  dplyr::select(Disease, current_cohort, previous_cohort)

# write to file
all_cohorts_cancer_groups_tpm_group_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "all_cohorts_cancer_groups_tpm_group_wise.tsv"), na = "NA")

# display   
all_cohorts_cancer_groups_tpm_group_wise
```


### Changes in common columns across tpm tables

#### Check gene symbols
```{r gene symbols gene wise}
changes_gene_symbols_gene_wise <- 
  changes_in_columns(current_gene_wise_table,previous_gene_wise_table, "Gene_symbol")

# write to file
changes_gene_symbols_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "changes_in_gene_symbols_tpm_gene_wise.tsv"), na = "NA")

# display   
changes_gene_symbols_gene_wise
```

```{r gene symbols group wise}
changes_gene_symbols_group_wise <- 
  changes_in_columns(current_group_wise_table,previous_group_wise_table, "Gene_symbol")

# write to file
changes_gene_symbols_group_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "changes_in_gene_symbols_tpm_group_wise.tsv"), na = "NA")

# display   
changes_gene_symbols_group_wise
```


#### Check Ensembl IDs
```{r ensembl ids gene wise}
changes_ensembl_ids_gene_wise <- 
  changes_in_columns(current_gene_wise_table,previous_gene_wise_table, "Gene_Ensembl_ID")

# write to file
changes_ensembl_ids_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "changes_in_ensembl_ids_tpm_gene_wise.tsv"), na = "NA")

# display   
changes_ensembl_ids_gene_wise
```

```{r ensembl ids froup wise}
changes_ensembl_ids_group_wise <- 
  changes_in_columns(current_group_wise_table, previous_group_wise_table, "Gene_Ensembl_ID")

# write to file
changes_ensembl_ids_group_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "changes_in_ensembl_ids_tpm_group_wise.tsv"), na = "NA")

# display   
changes_ensembl_ids_group_wise
```


#### Check cancer groups
```{r disease gene wise}
changes_disease_gene_wise <- 
  changes_in_columns(current_gene_wise_table,previous_gene_wise_table, "Disease")

# write to file
changes_disease_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "changes_in_disease_tpm_gene_wise.tsv"), na = "NA")

# display   
changes_disease_gene_wise
```


```{r disease group wise}
changes_disease_group_wise <- 
  changes_in_columns(current_group_wise_table,previous_group_wise_table, "Disease")

# write to file
changes_disease_group_wise %>% 
  readr::write_tsv(file.path(results_dir, 
                             "changes_in_disease_tpm_group_wise.tsv"), na = "NA")

# display   
changes_disease_group_wise
```



#### Check EFO IDs
```{r efo ids gene wise}
changes_efo_ids_gene_wise <- 
  changes_in_columns(current_gene_wise_table,previous_gene_wise_table,"EFO")

# write to file
changes_efo_ids_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, "changes_in_efo_ids_tpm_gene_wise.tsv"), na = "NA")

# display   
changes_efo_ids_gene_wise
```

```{r efo ids group wise}
changes_efo_ids_group_wise <- 
  changes_in_columns(current_group_wise_table,previous_group_wise_table,"EFO")

# write to file
changes_efo_ids_group_wise %>% 
  readr::write_tsv(file.path(results_dir, "changes_in_efo_ids_tpm_group_wise.tsv"), na = "NA")

# display   
changes_efo_ids_group_wise
```


#### Check MONDO IDs
```{r mondo ids gene wise}
changes_mondo_ids_gene_wise <- 
  changes_in_columns(current_gene_wise_table,previous_gene_wise_table,"MONDO")

# write to file
changes_mondo_ids_gene_wise %>% 
  readr::write_tsv(file.path(results_dir, "changes_in_mondo_ids_tpm_gene_wise.tsv"), na = "NA")

# display   
changes_mondo_ids_gene_wise
```

```{r mondo ids group wise}
changes_mondo_ids_group_wise <- 
  changes_in_columns(current_group_wise_table,previous_group_wise_table,"MONDO")

# write to file
changes_mondo_ids_group_wise %>% 
  readr::write_tsv(file.path(results_dir, "changes_in_mondo_ids_tpm_group_wise.tsv"), na = "NA")

# display   
changes_mondo_ids_group_wise
```

### Generate excel output for all QC checks and summaries
```{r generate qc files}
# read all QC  checks and summaries files 
qc_files <- list.files(results_dir, pattern = "tsv$")
qc_files_list <- lapply(qc_files, function(x) {
  # read each file
  qc_file_df <- readr::read_tsv(file.path(results_dir, x))
  return(qc_file_df)
})
# get file names
qc_files_names <- gsub(".tsv", "", qc_files)
names(qc_files_list) <- qc_files_names
# write results to excel workbook 
qc_files_list %>% 
  openxlsx::write.xlsx(file.path(results_dir, 
                                 paste0(gsub(".tsv.gz", "", 
                                             basename(params$current_table)), 
                                        ".xlsx")), 
                       overwrite = TRUE, keepNA = TRUE, na.string = "NA")
```
