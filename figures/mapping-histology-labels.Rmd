---
title: "Mapping histology labels for plots"
output:   
  html_notebook: 
    toc: true
    toc_float: true
author: Candace Savonen for ALSF - CCDL
date: 2021
---

# Purpose: 

The histology label variables included in `histologies.tsv` from data releases are not always useful for visualizing the full set of biospecimens due to the large number of different values.
Having too many different possible values makes the colors harder to distinguish.
In addition, there are some groups that are represented by only a very few samples; giving such groups a distinct color may be counterproductive.

The goal of this notebook is to use the currently existing `cancer_group` groups from `histologies.tsv`, to form group labels that can used for plotting purposes.

## The output table

The output of this notebook is a TSV file: `palettes/histology_label_color_table.tsv` that contains the following fields:

**Copied from `histologies.tsv`**:    
- `Kids_First_Biospecimen_ID` (from `histologies.tsv`)  
- All the original histology label variables (`cancer_group`, etc.)  
  
**Created in this notebook**:  
- `display_group` - the high-level cancer group labels that should be used for plotting   
- `hex_codes` the direct colors that should be used for plotting  

With this info, `histology_label_color_table.tsv` can be used by all plots and figures that summarize high level data  while displaying histology information. 

# How `display_group` is made:

Currently, display_group is completed based on `cancer_group` - each `cancer_group` counts as a display_group. For tumor specimens with `cancer_group` as NA, `Unknown` is addded. 

# Usage

This notebook can be run via the command line from the top directory of the 
repository as follows:

```
Rscript -e "rmarkdown::render('figures/mapping-histology-labels.Rmd', clean = TRUE)"
```

## Set Up

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

### Directories and Files

```{r}
# Path to input directory
input_dir <- file.path("..", "data")
output_dir <- "palettes"
```

# Read in metadata 

Which variables are we keeping for this table? 

```{r}
histology_variables <- "cancer_group"
```

Let's read in the current release's `histologies.tsv` file. 

```{r}
metadata <-
  readr::read_tsv(file.path(input_dir, "histologies.tsv"), guess_max = 100000)
```

Now we'll select histology variables we mentioned above and so capitalization differences don't get in the way with this process, we will change everything to lower case for now. 

```{r}
working_metadata <- metadata %>% 
  dplyr::select(Kids_First_Biospecimen_ID, sample_type, histology_variables) 
```

# Take a look at how many biospecimens per `cancer_group` group

Let's summarize `cancer_group`. 
Because the `Normal` samples don't have `cancer_group`, we'll look at just the `Tumor` samples at for this summary. 

```{r}
cancer_group_summary <- working_metadata %>% 
  dplyr::filter(sample_type == "Tumor") %>%
  dplyr::count(cancer_group) %>% 
  dplyr::arrange(n) 
```

For plotting purposes, we only want to plot cancer groups with n>=5, hence when generating the file, we only need colors for those samples
```{r}
cancer_group_summary <- working_metadata %>% 
  dplyr::filter(sample_type == "Tumor") %>%
  dplyr::count(cancer_group) %>% 
  dplyr::arrange(n) 
```

Let's print out the summary. 

```{r}
cancer_group_summary  %>% 
  knitr::kable()
```

There's handful of very small groups (many are n = 2). 

## Declare new equivalent groups
Currently, we have all non-CNS cancer groups - hence no longer applicable to declare equivalent groups

# Make new `display_group`

```{r}
histology_table <- working_metadata %>% 
  dplyr::filter(sample_type == "Tumor") %>%
  dplyr::mutate(
    # NAs are tumor samples  with pathology_diagnosis ==`Dysplasia/Gliosis` and `Other`
    display_group = tidyr::replace_na(cancer_group, "Unknown"),
    # Now do the group combining
    display_group = forcats::fct_collapse(display_group),
    # Put this as a character for later handling
    display_group = as.character(display_group)
    ) %>% 
  # no need to plot cancer group of NA
  dplyr::filter(display_group != "Unknown")
```

Print out the number of `display_group` - does not include `cancer_group == "Unknown")

```{r}
display_group_df <- histology_table %>% 
  dplyr::count(display_group) %>% 
  dplyr::arrange(n)

knitr::kable(display_group_df)
```

Make this notebook stop if there are more than 128 histology groups - does not include `cancer_group == "Unknown")

```{r}
if (nrow(display_group_df) > 128) {
  stop("There are more than 128 categories in `display_group`. We may want to re-evaluate the high-level histology groupings")
}
```

# Make `display_order`

Get ranks in order of big to small and make them into a new column in `display_group_df`. 
We will always want the "normal", "benign", "other_tumor" groups to come last so we will push then to the end of the factor order. 

```{r}
display_order_df <- display_group_df %>% 
  dplyr::mutate(display_group = forcats::fct_reorder(display_group, n, .desc = TRUE)) %>%
  dplyr::mutate(display_order = as.numeric(display_group)) # save the factor order for text table export
```

Add on the `display_order` column using `inner_join`.

```{r}
histology_table <- histology_table %>%
  # Join on the display orders
  dplyr::inner_join(display_order_df, by = "display_group") 
```

# Add hex codes 

These hex codes were retrieved from http://phrogz.net/css/distinct-colors.html with the of 15 degree hue step, 50% saturation step and 5% value step for 128 colors.

```{r}
color_palette <- c("#ff0000", "#f20000", "#a60000", "#4c0000", "#cc6666", "#8c4646", "#592d2d", "#331a1a", "#cc3300", "#7f2000", "#591600", "#330d00", "#e58f73", "#7f5040", "#402820", "#ff8000", "#a65300", "#663300", "#331a00", "#ffbf80", "#99734d", "#664d33", "#33261a", "#ffbf00", "#b28600", "#7f6000", "#4c3900", "#ffdf80", "#bfa760", "#736439", "#403820", "#ffff00", "#e5e600", "#d9d900", "#bfbf00", "#8c8c00", "#7f8000", "#4c4d00", "#333300", "#f2f279", "#99cc00", "#4c6600", "#91a653", "#4e592d", "#7fff00", "#53a600", "#bfff80", "#304020", "#104000", "#78bf60", "#008000", "#006600", "#005900", "#468c46", "#2d592d", "#00e639", "#7fff9f", "#00b359", "#00331a", "#73e6ac", "#4d9973", "#264d39", "#00ffbf", "#00664d", "#66ccb3", "#1a332d", "#00b3b3", "#009999", "#008c8c", "#006666", "#004040", "#79f2f2", "#0099cc", "#00698c", "#73c9e6", "#5391a6", "#335966", "#203840", "#0079f2", "#0053a6", "#002d59", "#80bfff", "#608fbf", "#395673", "#003df2", "#002699", "#001966", "#000d33", "#6c87d9", "#394873", "#1a2033", "#0000d9", "#0000bf", "#000059", "#8080ff", "#404080", "#7860bf", "#8000ff", "#390073", "#bf80ff", "#432d59", "#9900cc", "#69008c", "#260033", "#9153a6", "#2d1a33", "#f200f2", "#d900d9", "#990099", "#590059", "#4d004d", "#f279f2", "#663366", "#f200b6", "#990073", "#994d86", "#ff0080", "#bf0060", "#730039", "#4c0026", "#d96ca3", "#4d2639", "#331a26", "#f2003d", "#8c0023", "#400010", "#f27997", "#804050"
)
```

Declare how many colors we need. 

```{r}
n_colors <- nrow(display_group_df)
```

Make a named list color key where histologies are the names. 

```{r}
# Set seed so the colors are consistent upon re-run
set.seed(2021)

# Sample from the 94 colors
subset_colors <- sample(color_palette, n_colors)
names(subset_colors) <- display_group_df$display_group
```

Use `pie` function to preview what these look like.

```{r}
pie(rep(1, n_colors), 
    col = subset_colors, 
    labels = names(subset_colors))
```

Add the hex codes to the `histology_table`. 

```{r}
histology_table <- histology_table %>%
  # We don't need this anymore
  dplyr::select(-cancer_group) %>% 
  # Add the hex_codes
  dplyr::mutate(hex_codes = dplyr::recode(display_group, !!!subset_colors)) %>% 
  # Restore capitalization so its pretty for labeling
  dplyr::mutate(display_group = stringr::str_to_sentence(display_group))
```

## Save to TSV 

```{r}
readr::write_tsv(histology_table, file.path(output_dir, "histology_label_color_table.tsv"))
```

# Session Info

```{r}
sessionInfo()
```
